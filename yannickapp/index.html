<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-itunes-app" content="app-id=1265001179, app-argument=https://testapp.yannick-cake.com/yannickapplink">
    <title>Open App or Store</title>

    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            margin: 0;
        }
        .container {
            text-align: center;
            display: flex;
            flex-direction: column; /* 垂直排列 */
            align-items: center;
        }
        .text {
            font-size: 18px; /* 放大字體大小 */
            color: #333;
        }
        .title {
            width: 90%;
            text-align: center; /* 文字置中 */
            word-wrap: break-word; /* 自動換行 */
            word-break: break-word; /* 支援單詞斷行 */
            white-space: normal; /* 確保文字能換行 */
        }
        .button {
            padding: 10px 20px;
            font-size: 16px;
            margin-top: 10px;
            margin-bottom: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            min-width: 100px; /* 設置按鈕寬度一致 */
        }
        .button:hover {
            background-color: #0056b3;
        }
        #storeButton:hover {
            background-color: #0056b3;
        }
        #openButton {
            background-color: #c13a36;
        }
        footer {
            position: fixed;
            bottom: 10px;
            font-size: 14px;
            color: #555;
            text-align: center;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <p class="text title">點擊「開啟」啟動APP或前往應用程式商店</p>
        <button id="openButton" class="button">開啟</button>
        <a href="https://testapp.yannick-cake.com/yannickapplink" class="button">開啟</a>
    </div>

    <footer>v2.0</footer>
    
    <script>
        window.onload = function() {
            const isAutoRedirect = false; // 開啟網頁自動跳轉
            const appLink = "yannickapp://app.yannick";
            const universalLink = "https://testapp.yannick-cake.com/yannickapplink";
            var os = getMobileOperatingSystem();
            var storeLink;
            
            // 判斷使用者裝置類型
            function getMobileOperatingSystem() {
                var userAgent = navigator.userAgent || navigator.vendor || window.opera;

                if (/android/i.test(userAgent)) {
                    return "Android";
                }

                if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    return "iOS";
                }

                return "unknown";
            }

            function redirectAppOrStore() {
                if (os === "iOS") {
                    // var link = document.createElement('a');
                    // link.href = universalLink + "?fallbackUrl=" + storeLink;
                    // link.style.display = 'none';
                    // document.body.appendChild(link);
                    // link.click();
                    window.open(universalLink + "?fallbackUrl=" + storeLink, "_self");
                } else {
                    var iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.src = appLink;
                    document.body.appendChild(iframe);

                    setTimeout(function() {
                        document.body.removeChild(iframe);
                        window.location = storeLink;
                    }, 500);
                }
                
            }

            // 根據操作系統決定跳轉到 App Store 或 Play Store
            if (os === "iOS") {
                storeLink = "https://apps.apple.com/app/1265001179";  // iOS App Store
            } else if (os === "Android") {
                storeLink = "https://play.google.com/store/apps/details?id=com.yannick.app";  // Android Play Store
            } else {
                // 如果無法判斷，則跳轉到一個網頁
                storeLink = "https://www.yannick.com.tw/";
            }


            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === "hidden") {
                    // 獲取當前的基礎 URL（不包括查詢參數）
                    const baseUrl = window.location.origin + window.location.pathname;
                    // 使用 history.pushState 修改網址，但保留當前的標題
                    history.pushState({}, document.title, baseUrl);
                }
            });


            // 設置按鈕點擊事件，讓用戶手動開啟APP，當APP不存在則導頁至商店
            document.getElementById("openButton").onclick = function() {
                redirectAppOrStore();
            };


            if (os === "iOS") {
                // 檢查是否存在 fallbackUrl
                const currentUrl = new URL(window.location.href);
                const fallbackUrl = currentUrl.searchParams.get('fallbackUrl');
                const allowedDomains = ['apps.apple.com', 'play.google.com'];

                if (fallbackUrl && allowedDomains.some(domain => new URL(fallbackUrl).hostname.includes(domain))) {
                    try {
                        // 驗證 fallbackUrl 是否有效
                        new URL(fallbackUrl);

                        // 跳轉到 fallbackUrl
                        window.location.href = fallbackUrl;
                        return;
                    } catch (e) {
                        console.error('Invalid fallbackUrl:', fallbackUrl);
                    }
                }
            }

            if (isAutoRedirect) {
                redirectAppOrStore();
            }

        };
    </script>
</body>
</html>
